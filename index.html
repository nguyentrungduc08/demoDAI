<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Dynamic Ad Insertion</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

    <link rel="stylesheet" href="style.css">

    <link rel="preload" href="dist/hls-demo.js" as="script">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
  </head>

  <body>
    <div class="header-container">
      <header class="wrapper clearfix">
        <h2 >
          Dynamic Ad Insertion Demo
        </h2>
      </header>
    </div>


    <div class="container" id="listVideos">
      <span class="label label-primary">List Videos</span>
      <div class="row">
        <div class="column">
          <img class="demoVideo cursor video img-rounded" src="Resources/videos/i1.jpg" style="width:100%" onclick="currentVideo(1)" alt="video 1" id="vid1" name="CHO VỪA LÒNG EM | DUY MẠNH">
          <figcaption style="text-align: right;">4:56</figcaption>
        </div>
        <div class="column">
          <img class="demoVideo cursor video img-rounded" src="Resources/videos/i2.jpg" style="width:100%" onclick="currentVideo(2)" alt="video 2" id="vid2" name="Đắp Mộ Cuộc Tình - Quang Lập Bolero">
          <figcaption style="text-align: right;">04:11</figcaption>
        </div>
        <div class="column">
          <img class="demoVideo cursor video img-rounded" src="Resources/videos/i3.jpg" style="width:100%" onclick="currentVideo(3)" alt="video 3" id="vid3" name="Hoài Lâm - Trộm Nhìn Nhau">
          <figcaption style="text-align: right;">5:12</figcaption>
        </div>  
        <div class="column">
          <img class="demoVideo cursor video img-rounded" src="Resources/videos/i4.jpg" style="width:100%" onclick="currentVideo(4)" alt="video 4" id="vid4" name="Cát Bụi Cuộc Đời - Đạt Võ">
          <figcaption style="text-align: right;">5:31</figcaption>
        </div>
        <div class="column">
          <img class="demoVideo cursor video img-rounded" src="Resources/videos/i5.jpg" style="width:100%" onclick="currentVideo(5)" alt="video 5" id="vid5" name="video5">
          <figcaption style="text-align: right;">5:20</figcaption>
        </div>
        <div class="column">
          <img class="demoVideo cursor video img-rounded" src="Resources/videos/i6.jpg" style="width:100%" onclick="currentVideo(6)" alt="video 6" id="vid6" name="Thói Đời | Ca sĩ: Chế Linh & Đan Nguyên">
          <figcaption style="text-align: right;">3:55</figcaption>
        </div>
      </div>
    </div>

    <div class="container" id="listAds" style="pointer-events:none">
      <span class="label label-success">List Ads</span>
      <div class="row">
        <div class="column" ads_id="fadfheawf">
          <!-- SẢN XUẤT PHIM QUẢNG CÁO NGẮN TVC MI BICH CHI LOGO -->
          <img class="demoAds cursor ads img-rounded" src="Resources/ads/1.jpg" style="width:100%" id="ads1" alt="ads-1" title="abc">
          <figcaption style="text-align: right;" alt="04:11" id="ads-1">0:31</figcaption>
        </div>
        <div class="column">
          <!-- Quảng cáo ngắn về Đồng tiền & Giá trị cuộc sống -->
          <img class="demoAds cursor ads img-rounded" src="Resources/ads/2.jpg" style="width:100%" id="ads2" alt="ads-2">
          <figcaption style="text-align: right;" alt="02:13" id="ads-2">0:50</figcaption>
        </div>
        <div class="column">
          <img class="demoAds cursor ads img-rounded" src="Resources/ads/3.jpg" style="width:100%" id="ads3" alt="ads-3">
          <figcaption style="text-align: right;" alt="04:11" id="ads-3">0:31</figcaption>
        </div>
        <div class="column">
          <!-- Phim quảng cáo Ngân hàng ACB (ACB TVC) 2009 - 30s -->
          <img class="demoAds cursor ads img-rounded" src="Resources/ads/4.jpg" style="width:100%" id="ads4" alt="ads-4">
          <figcaption style="text-align: right;" alt="04:11" id="ads-4">0:32</figcaption>
        </div>
        <div class="column">
          <!-- TVC NGÂN HÀNG AGRIBANK -->
          <img class="demoAds cursor ads img-rounded" src="Resources/ads/5.jpg" style="width:100%" id="ads5" alt="ads-5">
          <figcaption style="text-align: right;" alt="04:11" id="ads-5">0:36</figcaption>
        </div>
        <div class="column">
          <!-- TVC ZALO VIDEO CALL - THẤY LÀ YÊU THƯƠNG -->
          <img class="demoAds cursor ads img-rounded" src="Resources/ads/6.jpg" style="width:100%" id="ads6" alt="ads-6">
          <figcaption style="text-align: right;" alt="00:00" id="ads-6">0:29</figcaption>
        </div>
      </div>
    </div>

    <div>
      <br>
    </div>

    <div class="main-container container">
      <div class="col-xs-7">  
        <video id="video" width="640" height="360" controls autoplay poster="Resources/videos/i1.jpg"></video>
        <br>
        <div style="height: 10px; background-color: red; width: 640px">
        </div>
        <br>
        <div>
            <b><span id="titleVideoName" >CHO VỪA LÒNG EM | DUY MẠNH</span></b>
        </div>
      </div>

      <div class="col-xs-5 table-responsive" style="height: 400px">  
        <table class="table table-striped table-responsive col-xs-5" id="tableAds">
            <tr>
                <col width="30%">
                <col width="30%">
                <col width="20%">
                <col width="20%">
                <th>Name</th>
                <th>Duration</th> 
                <th>Time</th>
                <th></th>
            </tr>
        </table>

        <div align="center">
          <input type="submit" name="insert" id="insert" class="btn btn-success" value="Play" onclick="playVideo()">
        </div>
      </div>
      <br>
      <canvas id="bufferedCanvas" height="15" class="videoCentered" onclick="onClickBufferedRange(event);"></canvas>
    </div>

    <footer>
      <br><br><br>
    </footer>

    <!-- Demo page required libs -->
    <script src="canvas.js"></script>
    <script src="metrics.js"></script>
    <script src="jsonpack.js"></script>
    <script>
        $(document).ready(function(){
            $('#ads1').click(function(e) {
                var item = $(this);
                var subMenuEl = item.parent().find('#ads-1');
                selectAd(1);
                var adname = $(this).attr('alt');
                var adId = $(this).attr("ads_id");
                insertToTableAds(adname, subMenuEl.attr('alt'), adId);
            })
            $('#ads2').click(function(e) {
                var item = $(this);
                var subMenuEl = item.parent().find('#ads-2');
                var x = subMenuEl.attr('alt');
                selectAd(2);
                var adname = $(this).attr('alt');
                insertToTableAds(adname, subMenuEl.attr('alt'));
            })
            $('#ads3').click(function(e) {
                var item = $(this);
                var subMenuEl = item.parent().find('#ads-3');
                var x = subMenuEl.attr('alt');
                selectAd(3);
                var adname = $(this).attr('alt');
                insertToTableAds(adname, subMenuEl.attr('alt'));
            })
            $('#ads4').click(function(e) {
                var item = $(this);
                var subMenuEl = item.parent().find('#ads-4');
                var x = subMenuEl.attr('alt');
                selectAd(4);
                var adname = $(this).attr('alt');
                insertToTableAds(adname, subMenuEl.attr('alt'));
            })
            $('#ads5').click(function(e) {
                var item = $(this);
                var subMenuEl = item.parent().find('#ads-5');
                var x = subMenuEl.attr('alt');
                selectAd(5);
                var adname = $(this).attr('alt');
                insertToTableAds(adname, subMenuEl.attr('alt'));
            })
            $('#ads6').click(function(e) {
                var item = $(this);
                var subMenuEl = item.parent().find('#ads-6');
                var x = subMenuEl.attr('alt');
                selectAd(6);
                var adname = $(this).attr('alt');
                insertToTableAds(adname, subMenuEl.attr('alt'));
            })
        });

      (function() {
        function loadScript(url, onLoad) {
          var s = document.createElement("script");
          s.setAttribute('src', url);
          if (onLoad) {
            s.onload = onLoad;
          }
          document.body.appendChild(s);
        }

        // load compiled lib dist, or latest canary from jsdelivr (?canary=true)
        var src = window.location.search.substring(1).split('&').indexOf('canary=true') >= 0
          ? 'https://cdn.jsdelivr.net/npm/hls.js@canary'
          : 'dist/hls.js';

        loadScript(src, function() {
          // load compiled demo main
          loadScript('dist/hls-demo.js');
        });
      })();
      
      //Global variables
      var videoId = "-1";   
      var flagShowAd = 0;

      function deleteRow(btn) {
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
      }

      function currentVideo(n) {
        flagShowAd = 1;
        selectVideo(slideIndex = n);
      }

      function currentAd(n) {
        if (flagShowAd == 1){
          selectAd(slideIndex = n);
        }
      }

      function insertToTableAds(adName, adTime, adId) {
        var table = document.getElementById("tableAds");
        var row = table.insertRow(2);

        $(row).addClass("ads_row");
        $(row).attr("ads_id", "fasdfasf");

        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);

        cell1.innerHTML = adName; 
        cell2.innerHTML = adTime;
        cell3.innerHTML = cell3.innerHTML + "<input type='text' name='insertTime' class='form-control' placeholder='00:00' value=''>";
        cell4.innerHTML = cell4.innerHTML + "<button tyep='button' name='remove_details' class='btn btn-danger btn-xs remove_details' id='2' onclick='deleteRow(this)'>Remove</button>";
      }

      function selectAd(n) {
        var i;
        var ads = document.getElementsByClassName("ads");

        for (i = 0; i < ads.length; i++) {
            ads[i].className = ads[i].className.replace(" active", "");
        }

        ads[n-1].className += " active";    
      }

      function selectVideo(n) {
        var i;
        var videos = document.getElementsByClassName("video");
        var listAds = document.getElementById("listAds");

        for (i = 0; i < videos.length; i++) {
            videos[i].className = videos[i].className.replace(" active", "");
        }

        videos[n-1].className += " active";
        videoId = videos[n-1].id;
        var imgVideo = document.getElementById("video");
        imgVideo.poster = videos[n-1].src;
        listAds.style.pointerEvents = "fill";
        document.getElementById("titleVideoName").innerHTML = videos[n-1].name;
      }

      function playVideo() {
        // alert(videoId);
        var listAds = "";  
        var listTimes = document.getElementsByName("insertTime");
        
        const HttpRequest = new XMLHttpRequest();
        // const Http = new XMLHttpRequest();
        // SdPtl76SdDpStwzl9W
        // gQsiKleN5rTNLFHxjG
        // QMriw7wGaD3GqxCYVW
        const url='http://127.0.0.1:6655/daim3u8?vid=QszkiKwhg-lhw7WbRm&ads=SdPtl76SdDpStwzl9W:15,gQsiKleN5rTNLFHxjG:20,QMriw7wGaD3GqxCYVW:8';
        // const url='http://127.0.0.1:9999/index.m3u8';
        // HttpRequest.open("GET", url);
        // HttpRequest.send();
        // HttpRequest.onreadystatechange=(e)=>{
        // console.log("Response: " + HttpRequest.responseText)
        // }

        // var video = document.getElementById("video");
        // var videoSrcHls = "http://127.0.0.1:9090/test.m3u8";
        var videoSrcHls = url;

        if(Hls.isSupported()) {
          var hls = new Hls();  
          hls.loadSource(videoSrcHls);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED,function() {
            video.play();
          });
        }
      } 

    </script>
  </body>
</html>
